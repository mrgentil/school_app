<?php

namespace App\Http\Controllers;

use App\Http\Requests\ClassRequest;
use App\Models\Classe;
use App\Models\School;
use App\Services\ClassService;
use Illuminate\Http\Request;

class ClasseController extends Controller
{
    protected $classService;

    public function __construct(ClassService $classService)
    {
        $this->classService = $classService;
        $this->middleware('auth');
        // Retirez temporairement cette ligne pour déboguer
        // $this->authorizeResource(Classes::class, 'class');
    }

    // Ajoutez les autorisations manuellement dans chaque méthode
    public function index()
    {
        $this->authorize('viewAny', Classe::class);
        $classes = $this->classService->getClassesForUser(auth()->user());
        return view('classes.index', compact('classes'));
    }


    public function create()
    {
        $this->authorize('create', Classe::class);
        $schools = School::all();
        return view('classes.form', compact('schools'));
    }

    public function store(ClassRequest $request)
    {
        $class = $this->classService->store($request->validated(), auth()->user());
        return redirect()->route('classes.index')
            ->with('success', 'Classe créée avec succès.');
    }

    public function edit(Classe $class)
{
    $schools = School::all();
    return view('classes.form', compact('class', 'schools'));
}

public function update(ClassRequest $request, Classe $class)
    {
        $this->classService->update($class, $request->validated());
        return redirect()->route('classes.index')
            ->with('success', 'Classe mise à jour avec succès.');
    }

    public function destroy(Classe $class)
    {
        $this->classService->delete($class);
        return redirect()->route('classes.index')
            ->with('success', 'Classe supprimée avec succès.');
    }
}
